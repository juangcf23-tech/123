<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema RID - J Demito Caltins & Formacal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .status-corrigido { background-color: #dcfce7; border-color: #bbf7d0; }
        .status-vencido { background-color: #fecaca; border-color: #fca5a5; }
        .profile-pic { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .notification-bubble { 
            background: #ef4444; 
            color: white; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -5px;
            right: -5px;
        }
        .rid-item { transition: all 0.3s ease; }
        .rid-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .progress-bar { height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: #3b82f6; transition: width 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Tela de Login -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="flex justify-center space-x-4 mb-6">
                    <div class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">J DEMITO CALTINS</div>
                    <div class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold">FORMACAL</div>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Sistema RID</h1>
                <p class="text-gray-600">Faça login para continuar</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CPF</label>
                    <input type="text" id="cpfLogin" placeholder="000.000.000-00" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="senhaLogin" placeholder="Digite sua senha"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                    Entrar
                </button>
            </form>
            
            <div class="mt-6 text-center space-y-2">
                <button id="forgotPasswordBtn" class="text-blue-600 hover:underline text-sm">Esqueci minha senha</button>
                <br>
                <button id="createAccountBtn" class="text-green-600 hover:underline text-sm">Criar nova conta</button>
            </div>
        </div>
    </div>

    <!-- Tela de Criação de Conta -->
    <div id="createAccountScreen" class="hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-emerald-100">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Criar Conta</h2>
            <form id="createAccountForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">CPF</label>
                    <input type="text" id="cpfCreate" placeholder="000.000.000-00" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                    <input type="text" id="nomeCreate" placeholder="Digite seu nome completo" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
                    <input type="email" id="emailCreate" placeholder="seu@email.com" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="senhaCreate" placeholder="Digite uma senha segura" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    Criar Conta
                </button>
            </form>
            <button id="backToLoginBtn" class="w-full mt-4 text-gray-600 hover:underline">Voltar ao login</button>
        </div>
    </div>

    <!-- Dashboard Funcionário -->
    <div id="funcionarioDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 id="funcionarioNome" class="text-xl font-semibold text-gray-800">Bem-vindo, Funcionário</h1>
                <div class="relative">
                    <img id="funcionarioFoto" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%236b7280' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" 
                         class="profile-pic cursor-pointer border-2 border-gray-300" onclick="showProfile()">
                </div>
            </div>
        </div>

        <!-- Conteúdo -->
        <div class="max-w-4xl mx-auto p-6">
            <div class="mb-6">
                <h2 class="text-lg font-medium text-gray-800 mb-4">Meus RIDs</h2>
                <div id="funcionarioRids" class="space-y-3">
                    <!-- RIDs serão inseridos aqui -->
                </div>
            </div>
            
            <div class="fixed bottom-6 right-6">
                <button onclick="showRidForm()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-medium shadow-lg hover:bg-blue-700 transition-colors">
                    + Criar RID
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard Líder/Admin -->
    <div id="liderDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 id="liderNome" class="text-xl font-semibold text-gray-800">Bem-vindo, Líder</h1>
                <div class="relative">
                    <img id="liderFoto" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%236b7280' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" 
                         class="profile-pic cursor-pointer border-2 border-gray-300" onclick="showProfile()">
                </div>
            </div>
        </div>

        <!-- Conteúdo -->
        <div class="max-w-6xl mx-auto p-6">
            <!-- Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-sm font-medium text-gray-600 mb-2">Total de RIDs</h3>
                    <p id="totalRids" class="text-3xl font-bold text-blue-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-sm font-medium text-gray-600 mb-2">RIDs Corrigidos</h3>
                    <p id="ridsCorrigidos" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-sm font-medium text-gray-600 mb-2">RIDs Vencidos</h3>
                    <p id="ridsVencidos" class="text-3xl font-bold text-red-600">0</p>
                </div>
            </div>

            <!-- Top 3 Emissores -->
            <div class="bg-white p-6 rounded-xl shadow-sm mb-8">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Top 3 Emissores do Mês</h3>
                <div id="topEmissores" class="space-y-3">
                    <!-- Top emissores serão inseridos aqui -->
                </div>
            </div>

            <!-- Lista de Funcionários -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Funcionários</h3>
                <div id="funcionariosList" class="space-y-3">
                    <!-- Funcionários serão inseridos aqui -->
                </div>
            </div>
            
            <div class="fixed bottom-6 right-6">
                <button onclick="showRidForm()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-medium shadow-lg hover:bg-blue-700 transition-colors">
                    + Criar novo RID
                </button>
            </div>
        </div>
    </div>

    <!-- Formulário RID -->
    <div id="ridFormScreen" class="hidden min-h-screen bg-gray-50">
        <div class="max-w-2xl mx-auto p-6">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Criar RID</h2>
                    <button onclick="closeRidForm()" class="text-gray-500 hover:text-gray-700">✕</button>
                </div>

                <!-- Barra de Progresso -->
                <div class="progress-bar mb-6">
                    <div id="progressFill" class="progress-fill" style="width: 20%"></div>
                </div>

                <form id="ridForm">
                    <!-- Etapa 1: Emitente e Vínculo -->
                    <div class="form-step active" data-step="1">
                        <h3 class="text-lg font-medium mb-4">Emitente e Vínculo</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                                <input type="text" id="ridNome" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Vínculo</label>
                                <select id="ridVinculo" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Selecione...</option>
                                    <option value="funcionario">Funcionário</option>
                                    <option value="terceiro-contratado">Terceiro Contratado</option>
                                    <option value="terceiro-eventual">Terceiro Eventual</option>
                                    <option value="visitante">Visitante</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Etapa 2: Unidade e Setor -->
                    <div class="form-step" data-step="2">
                        <h3 class="text-lg font-medium mb-4">Unidade e Setor</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Unidade</label>
                                <select id="ridUnidade" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Selecione...</option>
                                    <option value="unidade-1">Unidade 1</option>
                                    <option value="unidade-2">Unidade 2</option>
                                    <option value="unidade-3">Unidade 3</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Setor Emitente</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" name="setor" value="adm" class="mr-2">
                                        Administrativo
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="setor" value="m-movel" class="mr-2">
                                        M. Móvel
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="setor" value="m-fixa" class="mr-2">
                                        M. Fixa
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="setor" value="m-eletrica" class="mr-2">
                                        M. Elétrica
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="setor" value="producao" class="mr-2">
                                        Produção
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="setor" value="mina" class="mr-2">
                                        Mina
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Etapa 3: Data e Incidente -->
                    <div class="form-step" data-step="3">
                        <h3 class="text-lg font-medium mb-4">Data e Incidente</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Data do Incidente</label>
                                <input type="date" id="ridData" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Incidente/Desvio</label>
                                <div class="grid grid-cols-1 gap-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" name="incidente" value="condicao-risco" class="mr-2">
                                        Condição de Risco
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="incidente" value="desvio-comportamental" class="mr-2">
                                        Desvio Comportamental
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="incidente" value="dano-material" class="mr-2">
                                        Dano Material
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="incidente" value="quase-acidente" class="mr-2">
                                        Quase Acidente
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Etapa 4: Local e Descrição -->
                    <div class="form-step" data-step="4">
                        <h3 class="text-lg font-medium mb-4">Local e Descrição</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Local da Ocorrência</label>
                                <input type="text" id="ridLocal" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descrição Detalhada</label>
                                <textarea id="ridDescricao" rows="4" required
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Etapa 5: Ação Imediata e Status -->
                    <div class="form-step" data-step="5">
                        <h3 class="text-lg font-medium mb-4">Ação Imediata e Status</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ação Imediata</label>
                                <textarea id="ridAcao" rows="4" required
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>
                            <div id="statusSection">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select id="ridStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="vencido">Vencido</option>
                                    <option value="corrigido">Corrigido</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Botões de Navegação -->
                    <div class="flex justify-between mt-8">
                        <button type="button" id="prevBtn" onclick="previousStep()" 
                                class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 hidden">
                            Anterior
                        </button>
                        <button type="button" id="nextBtn" onclick="nextStep()" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 ml-auto">
                            Próximo
                        </button>
                        <button type="submit" id="submitBtn" 
                                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 hidden">
                            Criar RID
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tela de Perfil -->
    <div id="profileScreen" class="hidden min-h-screen bg-gray-50">
        <div class="max-w-md mx-auto p-6">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Perfil</h2>
                    <button onclick="closeProfile()" class="text-gray-500 hover:text-gray-700">✕</button>
                </div>

                <div class="text-center mb-6">
                    <div class="relative inline-block">
                        <img id="profileFoto" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%236b7280' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" 
                             class="w-24 h-24 rounded-full border-4 border-gray-300 mx-auto object-cover">
                        <button onclick="selectProfilePhoto()" class="absolute bottom-0 right-0 bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-blue-700 transition-colors">
                            📷
                        </button>
                        <input type="file" id="photoInput" accept="image/*" class="hidden" onchange="handlePhotoChange(event)">
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome para Exibição</label>
                        <input type="text" id="profileNome" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Setor/Departamento</label>
                        <input type="text" id="profileSetor" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                </div>

                <div class="mt-8 space-y-3">
                    <button onclick="saveProfile()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700">
                        Salvar Alterações
                    </button>
                    <button onclick="logout()" class="w-full bg-red-600 text-white py-3 rounded-lg font-medium hover:bg-red-700">
                        Sair
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dados simulados
        let currentUser = null;
        let currentStep = 1;
        let rids = [];
        let users = [
            { cpf: '111.111.111-11', nome: 'João Silva', email: 'joao@empresa.com', senha: 'senha123', tipo: 'lider', setor: 'Administração' },
            { cpf: '222.222.222-22', nome: 'Maria Santos', email: 'maria@empresa.com', senha: 'senha123', tipo: 'funcionario', setor: 'Produção' },
            { cpf: '333.333.333-33', nome: 'Pedro Costa', email: 'pedro@empresa.com', senha: 'senha123', tipo: 'funcionario', setor: 'Manutenção' }
        ];

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar data máxima como hoje
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ridData').max = today;

            // Event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('createAccountForm').addEventListener('submit', handleCreateAccount);
            document.getElementById('ridForm').addEventListener('submit', handleRidSubmit);
            document.getElementById('createAccountBtn').addEventListener('click', showCreateAccount);
            document.getElementById('backToLoginBtn').addEventListener('click', showLogin);
            document.getElementById('forgotPasswordBtn').addEventListener('click', handleForgotPassword);

            // Gerar alguns RIDs de exemplo
            generateSampleRids();
        });

        function handleLogin(e) {
            e.preventDefault();
            const cpf = document.getElementById('cpfLogin').value;
            const senha = document.getElementById('senhaLogin').value;

            const user = users.find(u => u.cpf === cpf && u.senha === senha);
            if (user) {
                currentUser = user;
                if (user.tipo === 'lider') {
                    showLiderDashboard();
                } else {
                    showFuncionarioDashboard();
                }
            } else {
                alert('CPF ou senha incorretos!');
            }
        }

        function handleCreateAccount(e) {
            e.preventDefault();
            const cpf = document.getElementById('cpfCreate').value;
            const nome = document.getElementById('nomeCreate').value;
            const email = document.getElementById('emailCreate').value;
            const senha = document.getElementById('senhaCreate').value;

            // Verificar se CPF já existe
            if (users.find(u => u.cpf === cpf)) {
                alert('CPF já cadastrado!');
                return;
            }

            // Determinar tipo baseado no CPF (simulação)
            const tipo = cpf.startsWith('111') ? 'lider' : 'funcionario';
            
            const newUser = { cpf, nome, email, senha, tipo, setor: 'Geral' };
            users.push(newUser);
            
            alert('Conta criada com sucesso!');
            showLogin();
        }

        function handleForgotPassword() {
            const email = prompt('Digite seu e-mail para recuperação:');
            if (email) {
                alert('Link de recuperação enviado para ' + email + ' (válido por 15 minutos)');
            }
        }

        function showLogin() {
            hideAllScreens();
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showCreateAccount() {
            hideAllScreens();
            document.getElementById('createAccountScreen').classList.remove('hidden');
        }

        function showFuncionarioDashboard() {
            hideAllScreens();
            document.getElementById('funcionarioDashboard').classList.remove('hidden');
            document.getElementById('funcionarioNome').textContent = `Bem-vindo, ${currentUser.nome.split(' ')[0]}`;
            
            // Carregar foto do usuário no header
            if (currentUser.foto) {
                document.getElementById('funcionarioFoto').src = currentUser.foto;
            }
            
            loadFuncionarioRids();
        }

        function showLiderDashboard() {
            hideAllScreens();
            document.getElementById('liderDashboard').classList.remove('hidden');
            document.getElementById('liderNome').textContent = `Bem-vindo, ${currentUser.nome.split(' ')[0]}`;
            
            // Carregar foto do usuário no header
            if (currentUser.foto) {
                document.getElementById('liderFoto').src = currentUser.foto;
            }
            
            loadLiderDashboard();
        }

        function showRidForm() {
            hideAllScreens();
            document.getElementById('ridFormScreen').classList.remove('hidden');
            document.getElementById('ridNome').value = currentUser.nome;
            
            // Ocultar seção de status para funcionários
            if (currentUser.tipo === 'funcionario') {
                document.getElementById('statusSection').style.display = 'none';
            }
            
            resetForm();
        }

        function showProfile() {
            hideAllScreens();
            document.getElementById('profileScreen').classList.remove('hidden');
            document.getElementById('profileNome').value = currentUser.nome.split(' ')[0];
            document.getElementById('profileSetor').value = currentUser.setor;
            
            // Carregar foto salva do usuário
            if (currentUser.foto) {
                document.getElementById('profileFoto').src = currentUser.foto;
            }
        }

        function closeProfile() {
            if (currentUser.tipo === 'lider') {
                showLiderDashboard();
            } else {
                showFuncionarioDashboard();
            }
        }

        function closeRidForm() {
            if (currentUser.tipo === 'lider') {
                showLiderDashboard();
            } else {
                showFuncionarioDashboard();
            }
        }

        function hideAllScreens() {
            const screens = ['loginScreen', 'createAccountScreen', 'funcionarioDashboard', 'liderDashboard', 'ridFormScreen', 'profileScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < 5) {
                    currentStep++;
                    updateFormStep();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                updateFormStep();
            }
        }

        function updateFormStep() {
            // Ocultar todas as etapas
            document.querySelectorAll('.form-step').forEach(step => {
                step.classList.remove('active');
            });

            // Mostrar etapa atual
            document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');

            // Atualizar barra de progresso
            const progress = (currentStep / 5) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // Atualizar botões
            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === 5);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== 5);
        }

        function validateCurrentStep() {
            const currentStepElement = document.querySelector(`[data-step="${currentStep}"]`);
            const requiredFields = currentStepElement.querySelectorAll('[required]');
            
            for (let field of requiredFields) {
                if (!field.value.trim()) {
                    alert('Por favor, preencha todos os campos obrigatórios.');
                    field.focus();
                    return false;
                }
            }

            // Validações específicas
            if (currentStep === 2) {
                const setores = document.querySelectorAll('input[name="setor"]:checked');
                if (setores.length === 0) {
                    alert('Selecione pelo menos um setor.');
                    return false;
                }
            }

            if (currentStep === 3) {
                const incidentes = document.querySelectorAll('input[name="incidente"]:checked');
                if (incidentes.length === 0) {
                    alert('Selecione pelo menos um tipo de incidente.');
                    return false;
                }
            }

            return true;
        }

        function resetForm() {
            currentStep = 1;
            updateFormStep();
            document.getElementById('ridForm').reset();
            document.getElementById('ridNome').value = currentUser.nome;
        }

        function handleRidSubmit(e) {
            e.preventDefault();
            
            if (!validateCurrentStep()) return;

            // Coletar dados do formulário
            const setores = Array.from(document.querySelectorAll('input[name="setor"]:checked')).map(cb => cb.value);
            const incidentes = Array.from(document.querySelectorAll('input[name="incidente"]:checked')).map(cb => cb.value);
            
            const ridData = {
                id: Date.now(),
                nome: document.getElementById('ridNome').value,
                vinculo: document.getElementById('ridVinculo').value,
                unidade: document.getElementById('ridUnidade').value,
                setores: setores,
                data: document.getElementById('ridData').value,
                incidentes: incidentes,
                local: document.getElementById('ridLocal').value,
                descricao: document.getElementById('ridDescricao').value,
                acao: document.getElementById('ridAcao').value,
                status: document.getElementById('ridStatus').value || 'vencido',
                emitente: currentUser.cpf,
                dataEmissao: new Date(),
                visualizado: false
            };

            rids.push(ridData);
            alert('RID criado com sucesso!');
            
            if (currentUser.tipo === 'lider') {
                showLiderDashboard();
            } else {
                showFuncionarioDashboard();
            }
        }

        function loadFuncionarioRids() {
            const funcionarioRids = rids.filter(rid => rid.emitente === currentUser.cpf);
            const container = document.getElementById('funcionarioRids');
            
            if (funcionarioRids.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum RID encontrado</p>';
                return;
            }

            container.innerHTML = funcionarioRids.map(rid => {
                const canRefazer = daysSince(rid.dataEmissao) >= 30 && rid.status === 'vencido';
                return `
                    <div class="rid-item p-4 border rounded-lg ${rid.status === 'corrigido' ? 'status-corrigido' : 'status-vencido'}">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-medium text-gray-800">RID #${rid.id}</h4>
                                <p class="text-sm text-gray-600">${rid.local}</p>
                                <p class="text-xs text-gray-500">${formatDate(rid.data)}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs px-2 py-1 rounded-full ${rid.status === 'corrigido' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${rid.status === 'corrigido' ? 'Corrigido' : 'Vencido'}
                                </span>
                                ${canRefazer ? '<button onclick="refazerRid(' + rid.id + ')" class="block mt-2 text-xs bg-blue-600 text-white px-3 py-1 rounded">Refazer RID</button>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadLiderDashboard() {
            // Estatísticas
            document.getElementById('totalRids').textContent = rids.length;
            document.getElementById('ridsCorrigidos').textContent = rids.filter(r => r.status === 'corrigido').length;
            document.getElementById('ridsVencidos').textContent = rids.filter(r => r.status === 'vencido').length;

            // Top 3 emissores
            const emissores = {};
            rids.forEach(rid => {
                const user = users.find(u => u.cpf === rid.emitente);
                if (user) {
                    emissores[user.nome] = (emissores[user.nome] || 0) + 1;
                }
            });

            const topEmissores = Object.entries(emissores)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3);

            document.getElementById('topEmissores').innerHTML = topEmissores.map(([nome, count], index) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="font-medium">${index + 1}º ${nome}</span>
                    <span class="text-blue-600 font-bold">${count} RIDs</span>
                </div>
            `).join('') || '<p class="text-gray-500">Nenhum emissor encontrado</p>';

            // Lista de funcionários
            loadFuncionariosList();
        }

        function loadFuncionariosList() {
            const funcionarios = users.filter(u => u.tipo === 'funcionario').sort((a, b) => a.nome.localeCompare(b.nome));
            const container = document.getElementById('funcionariosList');

            container.innerHTML = funcionarios.map(funcionario => {
                const funcionarioRids = rids.filter(rid => rid.emitente === funcionario.cpf);
                const novosRids = funcionarioRids.filter(rid => !rid.visualizado).length;
                
                return `
                    <div class="border rounded-lg p-4">
                        <div class="flex items-center justify-between cursor-pointer" onclick="toggleFuncionarioRids('${funcionario.cpf}')">
                            <div class="flex items-center space-x-3">
                                <div class="relative">
                                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%236b7280' viewBox='0 0 24 24'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" 
                                         class="profile-pic">
                                    ${novosRids > 0 ? `<div class="notification-bubble">${novosRids}</div>` : ''}
                                </div>
                                <span class="font-medium">${funcionario.nome}</span>
                            </div>
                            <svg class="w-5 h-5 transform transition-transform" id="arrow-${funcionario.cpf}">
                                <path fill="currentColor" d="M7 10l5 5 5-5z"/>
                            </svg>
                        </div>
                        <div id="rids-${funcionario.cpf}" class="hidden mt-4 space-y-2">
                            ${funcionarioRids.map(rid => `
                                <div class="p-3 bg-gray-50 rounded-lg ${rid.status === 'corrigido' ? 'status-corrigido' : 'status-vencido'}">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h5 class="font-medium">RID #${rid.id}</h5>
                                            <p class="text-sm text-gray-600">${rid.local}</p>
                                            <p class="text-xs text-gray-500">${formatDate(rid.data)}</p>
                                        </div>
                                        <select onchange="updateRidStatus(${rid.id}, this.value)" class="text-xs border rounded px-2 py-1">
                                            <option value="vencido" ${rid.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                                            <option value="corrigido" ${rid.status === 'corrigido' ? 'selected' : ''}>Corrigido</option>
                                        </select>
                                    </div>
                                </div>
                            `).join('') || '<p class="text-gray-500 text-sm">Nenhum RID encontrado</p>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleFuncionarioRids(cpf) {
            const ridsContainer = document.getElementById(`rids-${cpf}`);
            const arrow = document.getElementById(`arrow-${cpf}`);
            
            ridsContainer.classList.toggle('hidden');
            arrow.classList.toggle('rotate-180');

            // Marcar RIDs como visualizados
            rids.forEach(rid => {
                if (rid.emitente === cpf) {
                    rid.visualizado = true;
                }
            });

            // Recarregar lista para atualizar notificações
            setTimeout(() => loadFuncionariosList(), 100);
        }

        function updateRidStatus(ridId, newStatus) {
            const rid = rids.find(r => r.id === ridId);
            if (rid) {
                rid.status = newStatus;
                loadLiderDashboard();
                // Simular notificação ao funcionário
                alert(`Status do RID #${ridId} atualizado para: ${newStatus === 'corrigido' ? 'Corrigido' : 'Vencido'}`);
            }
        }

        function refazerRid(ridId) {
            const originalRid = rids.find(r => r.id === ridId);
            if (originalRid) {
                const newRid = {
                    ...originalRid,
                    id: Date.now(),
                    dataEmissao: new Date(),
                    visualizado: false
                };
                rids.push(newRid);
                alert('RID refeito com sucesso!');
                loadFuncionarioRids();
            }
        }

        function selectProfilePhoto() {
            document.getElementById('photoInput').click();
        }

        function handlePhotoChange(event) {
            const file = event.target.files[0];
            if (file) {
                // Verificar se é uma imagem
                if (!file.type.startsWith('image/')) {
                    alert('Por favor, selecione apenas arquivos de imagem.');
                    return;
                }

                // Verificar tamanho do arquivo (máximo 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('A imagem deve ter no máximo 5MB.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    
                    // Atualizar foto no perfil
                    document.getElementById('profileFoto').src = imageUrl;
                    
                    // Salvar no usuário atual
                    currentUser.foto = imageUrl;
                    
                    // Atualizar fotos nos dashboards
                    updateProfilePhotos(imageUrl);
                };
                reader.readAsDataURL(file);
            }
        }

        function updateProfilePhotos(imageUrl) {
            // Atualizar foto no header do funcionário
            const funcionarioFoto = document.getElementById('funcionarioFoto');
            if (funcionarioFoto) {
                funcionarioFoto.src = imageUrl;
            }
            
            // Atualizar foto no header do líder
            const liderFoto = document.getElementById('liderFoto');
            if (liderFoto) {
                liderFoto.src = imageUrl;
            }
        }

        function saveProfile() {
            const newName = document.getElementById('profileNome').value;
            currentUser.nome = newName;
            alert('Perfil atualizado com sucesso!');
            closeProfile();
        }

        function logout() {
            currentUser = null;
            showLogin();
        }

        function generateSampleRids() {
            const sampleRids = [
                {
                    id: 1001,
                    nome: 'Maria Santos',
                    vinculo: 'funcionario',
                    unidade: 'unidade-1',
                    setores: ['producao'],
                    data: '2024-01-15',
                    incidentes: ['condicao-risco'],
                    local: 'Linha de Produção A',
                    descricao: 'Vazamento de óleo no equipamento',
                    acao: 'Isolamento da área e limpeza',
                    status: 'vencido',
                    emitente: '222.222.222-22',
                    dataEmissao: new Date('2024-01-15'),
                    visualizado: false
                },
                {
                    id: 1002,
                    nome: 'Pedro Costa',
                    vinculo: 'funcionario',
                    unidade: 'unidade-2',
                    setores: ['m-fixa'],
                    data: '2024-01-20',
                    incidentes: ['dano-material'],
                    local: 'Oficina de Manutenção',
                    descricao: 'Ferramenta danificada durante uso',
                    acao: 'Substituição da ferramenta',
                    status: 'corrigido',
                    emitente: '333.333.333-33',
                    dataEmissao: new Date('2024-01-20'),
                    visualizado: true
                }
            ];
            rids.push(...sampleRids);
        }

        function daysSince(date) {
            const now = new Date();
            const diffTime = Math.abs(now - date);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'989a686a517c1ab7',t:'MTc1OTY0MDk3Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
